<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <title>exporter</title>

  <style>
    html, body {
      overflow: hidden;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #renderCanvas {
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    .buttons{
      position: fixed;
      padding: 20px;
    }

  </style>
</head>
<body>
<div class="buttons">
  <button id="exportGLTF">导出gltf文件</button>
  <button id="exportGLB">导出glb文件</button>
  <button id="exportBabylon">导出babylon文件</button>
</div>
<canvas id="renderCanvas"></canvas>

</body>
</html>
<script type="module">
  import * as BABYLON from 'babylonjs'
  import * as Exporter from 'babylonjs-serializers'
  const canvas = document.getElementById('renderCanvas')
  const engine = new BABYLON.Engine(canvas,true)
  const createScene = function (){
    const scene = new BABYLON.Scene(engine)
    const camera = new BABYLON.ArcRotateCamera(
            'camera',
            -Math.PI/2,
            Math.PI/2.5,
            10,
            new BABYLON.Vector3(0,0,0)
    )
    camera.attachControl(canvas,true)
    new BABYLON.HemisphericLight(
            'light',
            new BABYLON.Vector3(1,1,0),
            scene
    )

    const box = new BABYLON.MeshBuilder.CreateBox('box',{
      depth:3,
      width:2,
      height:1
    })
    const sphere = new BABYLON.MeshBuilder.CreateSphere('sphere',{
      segments:32,
      diameter:2
    })

    const gltfButton = document.getElementById('exportGLTF')
    gltfButton.addEventListener('click',()=>{
      Exporter.GLTF2Export.GLTFAsync(scene,'filename').then(gltf=>{
        gltf.downloadFiles()
      })
    })
    const glbButton = document.getElementById('exportGLB')
    glbButton.addEventListener('click',()=>{
      Exporter.GLTF2Export.GLBAsync(scene,'filename',{
        shouldExportNode(node) {
          // 可设置只导出部分内容
          return node !== box
        }
      }).then(glb=>{
        glb.downloadFiles()
      })
    })

    const babylonButton = document.getElementById('exportBabylon')
    babylonButton.addEventListener('click',()=>{
      doDownload('babylonjs',scene)
    })


    return scene

  }


  let objectUrl
  function doDownload(filename,scene){
    if(objectUrl){
      window.URL.revokeObjectURL(objectUrl)
    }
    const serializedScene = BABYLON.SceneSerializer.Serialize(scene)
    const strScene = JSON.stringify(serializedScene)
    if(filename.toLowerCase().lastIndexOf('.babylon')!== filename.length-8 ||
      filename.length<9
    ){
      filename+='.babylon'
    }
    const blob = new Blob([strScene],{type:'octet/stream'})

    objectUrl = (window.webkitURL || window.URL).createObjectURL(blob)
    const link = window.document.createElement('a')
    link.href = objectUrl
    link.download = filename

    const click = document.createEvent('MouseEvent')
    click.initEvent('click',true,false)
    link.dispatchEvent(click)

  }


  const scene = createScene()
  engine.runRenderLoop(function () {
    scene.render()
  })
  window.addEventListener('resize',function (){
    engine.resize()
  })


</script>
